openapi: 3.0.3
info:
  title: Telco Billing API
  description: API for billing operations in a telecommunications company
  version: 1.0.0

servers:
  - url: https://api.telco-example.com/v1
    description: Production server

paths:
  /billing/adjustments:
    post:
      summary: Create a billing adjustment
      operationId: createBillingAdjustment
      description: Creates a credit or debit adjustment on a customer's account
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BillingAdjustmentRequest'
      responses:
        '200':
          description: Adjustment created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BillingAdjustmentResponse'
        '400':
          description: Invalid request
        '404':
          description: Customer or invoice not found

      x-contextMesh:
        logicModule: telco_billing_resolution
        description: >
          Used by ContextMesh as part of billing dispute resolution workflows.
          Creates credit adjustments for approved disputes.
        templateParams:
          customerId: "{{db.customer.customer_id}}"
          invoiceNumber: "{{db.invoice.number}}"
          amount: "{{logic.recommended_credit_amount}}"
          reason: "Dispute resolution for invoice {{db.invoice.number}} - {{logic.resolution_reason}}"
          adjustmentType: "credit"
        stateUpdates:
          onSuccess:
            - write:
                table: billing_adjustment_log
                values:
                  case_id: "{{state.case_id}}"
                  adjustment_id: "{{response.adjustmentId}}"
                  customer_id: "{{db.customer.customer_id}}"
                  amount: "{{response.amount}}"
                  status: "APPLIED"
                  created_at: "{{response.createdAt}}"

  /crm/customers/{customerId}:
    get:
      summary: Get customer details
      operationId: getCustomer
      description: Retrieves detailed customer information including tenure and ARPU
      parameters:
        - name: customerId
          in: path
          required: true
          schema:
            type: string
          description: The customer ID
      responses:
        '200':
          description: Customer details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Customer'
        '404':
          description: Customer not found

      x-contextMesh:
        logicModule: telco_billing_resolution
        description: Fetches customer data for dispute resolution decisions
        templateParams:
          customerId: "{{db.customer.customer_id}}"

  /notifications/send:
    post:
      summary: Send notification to customer
      operationId: sendNotification
      description: Sends an email or SMS notification to the customer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NotificationRequest'
      responses:
        '200':
          description: Notification sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationResponse'
        '400':
          description: Invalid request

      x-contextMesh:
        logicModule: telco_billing_resolution
        description: Sends resolution notification to customer after dispute is processed
        templateParams:
          customerId: "{{db.customer.customer_id}}"
          channel: "email"
          templateId: "dispute_resolution"
          templateData:
            customerName: "{{db.customer.name}}"
            invoiceNumber: "{{db.invoice.number}}"
            resolutionType: "{{logic.resolution_type}}"
            creditAmount: "{{logic.recommended_credit_amount}}"
        stateUpdates:
          onSuccess:
            - write:
                table: notification_log
                values:
                  case_id: "{{state.case_id}}"
                  notification_id: "{{response.notificationId}}"
                  channel: "email"
                  status: "SENT"

  /tickets/create:
    post:
      summary: Create escalation ticket
      operationId: createEscalationTicket
      description: Creates a ticket for manual review when automated resolution is not possible
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TicketRequest'
      responses:
        '200':
          description: Ticket created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketResponse'

      x-contextMesh:
        logicModule: telco_billing_resolution
        description: Creates escalation ticket when dispute requires manual review
        templateParams:
          customerId: "{{db.customer.customer_id}}"
          category: "billing_dispute"
          priority: "high"
          subject: "Billing dispute escalation - Invoice {{db.invoice.number}}"
          description: "Customer dispute requires manual review. Reason: {{logic.resolution_reason}}"
          metadata:
            invoice_number: "{{db.invoice.number}}"
            dispute_amount: "{{db.invoice.disputed_amount}}"
            case_id: "{{state.case_id}}"
        stateUpdates:
          onSuccess:
            - write:
                table: escalation_log
                values:
                  case_id: "{{state.case_id}}"
                  ticket_id: "{{response.ticketId}}"
                  status: "ESCALATED"

components:
  schemas:
    BillingAdjustmentRequest:
      type: object
      required:
        - customerId
        - invoiceNumber
        - amount
        - adjustmentType
      properties:
        customerId:
          type: string
          description: Customer identifier
        invoiceNumber:
          type: string
          description: Invoice to adjust
        amount:
          type: number
          format: float
          description: Adjustment amount (positive for credit, negative for debit)
        adjustmentType:
          type: string
          enum: [credit, debit]
          description: Type of adjustment
        reason:
          type: string
          description: Reason for the adjustment

    BillingAdjustmentResponse:
      type: object
      properties:
        adjustmentId:
          type: string
          description: Unique adjustment identifier
        amount:
          type: number
          description: Applied adjustment amount
        newBalance:
          type: number
          description: Customer's new balance
        createdAt:
          type: string
          format: date-time
          description: When the adjustment was created

    Customer:
      type: object
      properties:
        customerId:
          type: string
        name:
          type: string
        email:
          type: string
        tenureMonths:
          type: integer
          description: How long customer has been with us
        arpu:
          type: number
          description: Average revenue per user
        churnRisk:
          type: string
          enum: [low, medium, high]
        outstandingBalance:
          type: number

    NotificationRequest:
      type: object
      required:
        - customerId
        - channel
        - templateId
      properties:
        customerId:
          type: string
        channel:
          type: string
          enum: [email, sms, push]
        templateId:
          type: string
        templateData:
          type: object
          additionalProperties: true

    NotificationResponse:
      type: object
      properties:
        notificationId:
          type: string
        status:
          type: string
          enum: [sent, queued, failed]
        sentAt:
          type: string
          format: date-time

    TicketRequest:
      type: object
      required:
        - customerId
        - category
        - subject
      properties:
        customerId:
          type: string
        category:
          type: string
        priority:
          type: string
          enum: [low, medium, high, critical]
        subject:
          type: string
        description:
          type: string
        metadata:
          type: object
          additionalProperties: true

    TicketResponse:
      type: object
      properties:
        ticketId:
          type: string
        status:
          type: string
        createdAt:
          type: string
          format: date-time
